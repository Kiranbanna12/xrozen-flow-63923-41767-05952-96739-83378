/**
 * Admin AI Models Management Page
 * Manage AI models and API keys for XrozenAI
 */

import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from "@/components/ui/alert-dialog";
import { SidebarProvider, SidebarTrigger } from "@/components/ui/sidebar";
import { AdminSidebar } from "@/components/AdminSidebar";
import { Brain, Plus, Trash2, Key, CheckCircle, XCircle, AlertCircle, Settings, ArrowUp, ArrowDown, Save, GripVertical } from "lucide-react";
import { toast } from "sonner";
import { apiClient } from "@/lib/api-client";
import { cn } from "@/lib/utils";

interface AIModel {
  id: string;
  provider: string;
  model_name: string;
  model_id: string;
  is_free: boolean;
  rate_limit_per_minute?: number;
  enabled: boolean;
  priority: number;
  created_at: string;
}

interface APIKey {
  id: string;
  provider: string;
  key_name: string;
  is_active: boolean;
  created_at: string;
}

// Available models grouped by provider
const AVAILABLE_MODELS = {
  openai: [
    { id: "gpt-4o", name: "GPT-4o (Latest)", priority: 100, isFree: false },
    { id: "gpt-4o-mini", name: "GPT-4o Mini", priority: 90, isFree: false },
    { id: "gpt-4-turbo", name: "GPT-4 Turbo", priority: 95, isFree: false },
    { id: "gpt-4", name: "GPT-4", priority: 92, isFree: false },
    { id: "gpt-3.5-turbo", name: "GPT-3.5 Turbo", priority: 85, isFree: false },
    { id: "gpt-3.5-turbo-16k", name: "GPT-3.5 Turbo 16K", priority: 83, isFree: false }
  ],
  gemini: [
    { id: "gemini-2.5-pro", name: "Gemini 2.5 Pro", priority: 98, isFree: false },
    { id: "gemini-2.5-flash", name: "Gemini 2.5 Flash", priority: 95, isFree: false },
    { id: "gemini-2.5-flash-lite", name: "Gemini 2.5 Flash-Lite", priority: 92, isFree: false },
    { id: "gemini-2.0-flash", name: "Gemini 2.0 Flash", priority: 90, isFree: false },
    { id: "gemini-2.0-flash-lite", name: "Gemini 2.0 Flash-Lite", priority: 88, isFree: false },
    { id: "gemini-2.0-flash-exp", name: "Gemini 2.0 Flash Experimental", priority: 86, isFree: false },
    { id: "gemini-1.5-pro", name: "Gemini 1.5 Pro", priority: 93, isFree: false },
    { id: "gemini-1.5-flash", name: "Gemini 1.5 Flash", priority: 87, isFree: false },
    { id: "gemini-pro", name: "Gemini Pro", priority: 85, isFree: false }
  ],
  openrouter: [
    { id: "deepseek/deepseek-chat-v3.1:free", name: "DeepSeek Chat v3.1", priority: 70, isFree: true },
    { id: "qwen/qwen3-235b-a22b:free", name: "Qwen3 235B A22B", priority: 65, isFree: true },
    { id: "meta-llama/llama-3.3-8b-instruct:free", name: "Meta Llama 3.3 8B", priority: 60, isFree: true },
    { id: "google/gemini-2.0-flash-exp:free", name: "Gemini 2.0 Flash (Free)", priority: 68, isFree: true },
    { id: "deepseek/deepseek-r1:free", name: "DeepSeek R1", priority: 67, isFree: true },
    { id: "meta-llama/llama-4-maverick:free", name: "Meta Llama 4 Maverick", priority: 58, isFree: true },
    { id: "qwen/qwen3-14b:free", name: "Qwen3 14B", priority: 55, isFree: true },
    { id: "mistralai/mistral-small-3.2-24b-instruct:free", name: "Mistral Small 3.2", priority: 57, isFree: true },
    { id: "google/gemma-3-27b-it:free", name: "Google Gemma 3 27B", priority: 54, isFree: true },
    { id: "moonshotai/kimi-dev-72b:free", name: "MoonshotAI Kimi Dev 72B", priority: 53, isFree: true }
  ]
};

export default function AdminAIModels() {
  const navigate = useNavigate();
  const [models, setModels] = useState<AIModel[]>([]);
  const [apiKeys, setAPIKeys] = useState<APIKey[]>([]);
  const [loading, setLoading] = useState(true);
  const [dialogOpen, setDialogOpen] = useState(false);
  const [keyDialogOpen, setKeyDialogOpen] = useState(false);
  const [selectedProvider, setSelectedProvider] = useState("openrouter");
  const [keyName, setKeyName] = useState("");
  const [apiKey, setApiKey] = useState("");
  const [editingPriority, setEditingPriority] = useState<string | null>(null);
  const [priorityValue, setPriorityValue] = useState<number>(50);
  const [savingPriorities, setSavingPriorities] = useState(false);
  const [addModelsDialogOpen, setAddModelsDialogOpen] = useState(false);
  const [selectedModelsToAdd, setSelectedModelsToAdd] = useState<string[]>([]);
  const [editingKey, setEditingKey] = useState<string | null>(null);
  const [editKeyName, setEditKeyName] = useState("");
  const [editKeyValue, setEditKeyValue] = useState("");
  const [activeTab, setActiveTab] = useState<"api-keys" | "models" | "usage" | "info">("api-keys");

  // Handler for adding selected models
  const handleAddSelectedModels = async () => {
    if (selectedModelsToAdd.length === 0) {
      toast.error("Please select at least one model to add");
      return;
    }

    try {
      let addedCount = 0;
      let errors = [];

      for (const modelId of selectedModelsToAdd) {
        // Determine provider based on model ID
        let endpoint = "";
        if (AVAILABLE_MODELS.openai.some((m) => m.id === modelId)) {
          endpoint = "/admin/ai-models/add-single-openai";
        } else if (AVAILABLE_MODELS.gemini.some((m) => m.id === modelId)) {
          endpoint = "/admin/ai-models/add-single-gemini";
        } else if (AVAILABLE_MODELS.openrouter.some((m) => m.id === modelId)) {
          endpoint = "/admin/ai-models/add-single-openrouter";
        }

        if (endpoint) {
          const result = await apiClient.post(endpoint, { modelId });
          if (result.success) {
            addedCount++;
          } else {
            errors.push(`${modelId}: ${result.error}`);
          }
        }
      }

      setAddModelsDialogOpen(false);
      setSelectedModelsToAdd([]);
      fetchModels();

      if (addedCount > 0) {
        toast.success(`Successfully added ${addedCount} model(s)`);
      }
      if (errors.length > 0) {
        toast.error(`Failed to add ${errors.length} model(s)`);
      }
    } catch (error) {
      toast.error("Error adding models");
    }
  };

  useEffect(() => {
    checkAdminAuth();
    loadData();
  }, []);

  const checkAdminAuth = async () => {
    try {
      const user = await apiClient.getCurrentUser();
      
      if (!user) {
        navigate("/auth");
        return;
      }
      
      // Check both user_category and userCategory for compatibility
      const isAdmin = user.user_category === 'admin' || 
                     user.userCategory === 'admin' || 
                     user.user_category === 'agency' || 
                     user.userCategory === 'agency';
      
      if (!isAdmin) {
        navigate("/auth");
        return;
      }
    } catch (error) {
      console.error('Admin auth check failed:', error);
      navigate("/auth");
    }
  };

  const loadData = async () => {
    try {
      // Load AI models and API keys using proper API endpoints
      const baseURL = 'http://localhost:3001/api';
      const token = localStorage.getItem('auth_token');
      
      if (!token) {
        toast.error("Authentication required");
        navigate("/auth");
        return;
      }
      
      const [modelsData, keysData] = await Promise.all([
        fetch(`${baseURL}/admin/ai-models`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(async r => {
          if (!r.ok) {
            throw new Error(`Models API failed: ${r.status}`);
          }
          return r.json();
        }),
        fetch(`${baseURL}/admin/ai-keys`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(async r => {
          if (!r.ok) {
            throw new Error(`Keys API failed: ${r.status}`);
          }
          return r.json();
        })
      ]);
      
      setModels(modelsData.data || []);
      setAPIKeys(keysData.data || []);
    } catch (error) {
      console.error("Error loading data:", error);
      toast.error("Failed to load AI models: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleAddFreeModels = async () => {
    try {
      const baseURL = 'http://localhost:3001/api';
      const token = localStorage.getItem('auth_token');
      const response = await fetch(`${baseURL}/admin/ai-models/add-openrouter-free`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      await response.json();
      toast.success(`Added ${FREE_OPENROUTER_MODELS.length} free OpenRouter models`);
      loadData();
    } catch (error) {
      console.error("Error adding free models:", error);
      toast.error("Failed to add free models");
    }
  };

  const handleAddOpenAIModels = async () => {
    try {
      const baseURL = 'http://localhost:3001/api';
      const token = localStorage.getItem('auth_token');
      const response = await fetch(`${baseURL}/admin/ai-models/add-openai`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        const errorMsg = typeof result.error === 'string' 
          ? result.error 
          : result.error?.message || "Failed to add OpenAI models";
        toast.error(errorMsg);
        return;
      }
      
      const successMsg = typeof result.data?.message === 'string'
        ? result.data.message
        : `Added ${result.data?.added || 0} OpenAI models successfully`;
      toast.success(successMsg);
      loadData();
    } catch (error: any) {
      console.error("Error adding OpenAI models:", error);
      toast.error("Failed to add OpenAI models. Make sure you've added an OpenAI API key first.");
    }
  };

  const handleAddGeminiModels = async () => {
    try {
      const baseURL = 'http://localhost:3001/api';
      const token = localStorage.getItem('auth_token');
      const response = await fetch(`${baseURL}/admin/ai-models/add-gemini`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        const errorMsg = typeof result.error === 'string' 
          ? result.error 
          : result.error?.message || "Failed to add Gemini models";
        toast.error(errorMsg);
        return;
      }
      
      const successMsg = typeof result.data?.message === 'string'
        ? result.data.message
        : `Added ${result.data?.added || 0} Gemini models successfully`;
      toast.success(successMsg);
      loadData();
    } catch (error: any) {
      console.error("Error adding Gemini models:", error);
      toast.error("Failed to add Gemini models. Make sure you've added a Gemini API key first.");
    }
  };

  const handleAddAPIKey = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!keyName.trim() || !apiKey.trim()) {
      toast.error("Please fill in all fields");
      return;
    }

    try {
      const baseURL = 'http://localhost:3001/api';
      const token = localStorage.getItem('auth_token');
      const response = await fetch(`${baseURL}/admin/ai-keys`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          provider: selectedProvider,
          key_name: keyName,
          api_key: apiKey
        })
      });

      await response.json();
      toast.success("API key added successfully");
      setKeyDialogOpen(false);
      setKeyName("");
      setApiKey("");
      loadData();
    } catch (error) {
      console.error("Error adding API key:", error);
      toast.error("Failed to add API key");
    }
  };

  const handleToggleModel = async (modelId: string, enabled: boolean) => {
    try {
      const baseURL = 'http://localhost:3001/api';
      const token = localStorage.getItem('auth_token');
      
      console.log('Toggling model:', modelId, 'to enabled:', enabled);
      
      const response = await fetch(`${baseURL}/admin/ai-models/${modelId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ enabled })
      });

      console.log('Toggle response status:', response.status);
      
      if (!response.ok) {
        const errorData = await response.json();
        console.error('Toggle error:', errorData);
        throw new Error(errorData.message || `HTTP ${response.status}`);
      }

      const result = await response.json();
      console.log('Toggle success:', result);
      
      setModels(models.map(m => m.id === modelId ? { ...m, enabled } : m));
      toast.success(enabled ? "Model enabled" : "Model disabled");
    } catch (error) {
      console.error("Error toggling model:", error);
      toast.error(`Failed to update model: ${error.message}`);
    }
  };

  const handleDeleteKey = async (keyId: string) => {
    try {
      const baseURL = 'http://localhost:3001/api';
      const token = localStorage.getItem('auth_token');
      await fetch(`${baseURL}/admin/ai-keys/${keyId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      setAPIKeys(apiKeys.filter(k => k.id !== keyId));
      toast.success("API key deleted");
    } catch (error) {
      console.error("Error deleting key:", error);
      toast.error("Failed to delete API key");
    }
  };

  const handleUpdatePriority = async (modelId: string, newPriority: number) => {
    try {
      const baseURL = 'http://localhost:3001/api';
      const token = localStorage.getItem('auth_token');
      
      const response = await fetch(`${baseURL}/admin/ai-models/${modelId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ priority: newPriority })
      });

      if (!response.ok) {
        throw new Error('Failed to update priority');
      }

      setModels(models.map(m => m.id === modelId ? { ...m, priority: newPriority } : m));
      setEditingPriority(null);
      toast.success("Priority updated successfully");
    } catch (error) {
      console.error("Error updating priority:", error);
      toast.error("Failed to update priority");
    }
  };

  const handleMovePriority = async (modelId: string, direction: 'up' | 'down') => {
    const model = models.find(m => m.id === modelId);
    if (!model) return;

    const newPriority = direction === 'up' ? model.priority + 10 : Math.max(1, model.priority - 10);
    await handleUpdatePriority(modelId, newPriority);
  };

  const handleBulkReorderByPriority = async () => {
    try {
      setSavingPriorities(true);
      const baseURL = 'http://localhost:3001/api';
      const token = localStorage.getItem('auth_token');

      // Sort models by current priority
      const sortedModels = [...models].sort((a, b) => b.priority - a.priority);
      
      // Reassign priorities from 100 down
      const updates = sortedModels.map((model, index) => ({
        id: model.id,
        priority: 100 - (index * 5)
      }));

      const response = await fetch(`${baseURL}/admin/ai-models/bulk-priority`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ updates })
      });

      if (!response.ok) {
        throw new Error('Failed to update priorities');
      }

      await loadData();
      toast.success("Priorities reorganized successfully");
    } catch (error) {
      console.error("Error reorganizing priorities:", error);
      toast.error("Failed to reorganize priorities");
    } finally {
      setSavingPriorities(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
    );
  }

  return (
    <SidebarProvider>
      <div className="flex w-full min-h-screen">
        <AdminSidebar />
        <div className="flex-1 bg-background dark:bg-background">
          <header className="border-b bg-card/50 dark:bg-card/50 backdrop-blur-sm sticky top-0 z-50">
            <div className="flex items-center justify-between px-6 py-4">
              <div className="flex items-center gap-4">
                <SidebarTrigger />
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-primary flex items-center justify-center shadow-glow">
                    <Brain className="w-5 h-5 text-primary-foreground" />
                  </div>
                  <div>
                    <h1 className="text-xl font-bold">AI Models Management</h1>
                    <p className="text-sm text-muted-foreground">Configure AI models and API keys for XrozenAI</p>
                  </div>
                </div>
              </div>
              
              <div className="flex gap-2 flex-wrap">
                <Button onClick={handleAddFreeModels} variant="outline" size="sm">
                  <Plus className="w-4 h-4 mr-2" />
                  Add Free Models
                </Button>
                <Button onClick={handleAddOpenAIModels} variant="outline" size="sm">
                  <Plus className="w-4 h-4 mr-2" />
                  Add OpenAI Models
                </Button>
                <Button onClick={handleAddGeminiModels} variant="outline" size="sm">
                  <Plus className="w-4 h-4 mr-2" />
                  Add Gemini Models
                </Button>
                <Dialog open={keyDialogOpen} onOpenChange={setKeyDialogOpen}>
                  <DialogTrigger asChild>
                    <Button className="gradient-primary">
                      <Key className="w-4 h-4 mr-2" />
                      Add API Key
                    </Button>
                  </DialogTrigger>
                  <DialogContent>
                    <DialogHeader>
                      <DialogTitle>Add API Key</DialogTitle>
                      <DialogDescription>
                        Add an API key for AI model providers
                      </DialogDescription>
                    </DialogHeader>
                    <form onSubmit={handleAddAPIKey} className="space-y-4">
                      <div className="space-y-2">
                        <Label>Provider</Label>
                        <Select value={selectedProvider} onValueChange={setSelectedProvider}>
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="openrouter">OpenRouter</SelectItem>
                            <SelectItem value="openai">OpenAI</SelectItem>
                            <SelectItem value="gemini">Google Gemini</SelectItem>
                            <SelectItem value="google">Google AI</SelectItem>
                            <SelectItem value="anthropic">Anthropic (Claude)</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                      
                      <div className="space-y-2">
                        <Label>Key Name</Label>
                        <Input
                          placeholder="e.g., OpenRouter Production"
                          value={keyName}
                          onChange={(e) => setKeyName(e.target.value)}
                          required
                        />
                      </div>
                      
                      <div className="space-y-2">
                        <Label>API Key</Label>
                        <Input
                          type="password"
                          placeholder="sk-..."
                          value={apiKey}
                          onChange={(e) => setApiKey(e.target.value)}
                          required
                        />
                      </div>
                      
                      <Button type="submit" className="w-full gradient-primary">
                        Add API Key
                      </Button>
                    </form>
                  </DialogContent>
                </Dialog>
              </div>
            </div>
          </header>

          <main className="px-8 py-8 space-y-8">
            {/* API Keys Section */}
            <Card>
              <CardHeader>
                <CardTitle>API Keys</CardTitle>
                <CardDescription>
                  Manage API keys for different AI providers
                </CardDescription>
              </CardHeader>
              <CardContent>
                {apiKeys.length === 0 ? (
                  <div className="text-center py-8 text-muted-foreground">
                    <Key className="w-12 h-12 mx-auto mb-4 opacity-50" />
                    <p>No API keys configured</p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {apiKeys.map((key) => (
                      <div key={key.id} className="flex items-center justify-between p-4 border rounded-lg">
                        <div className="flex items-center gap-3">
                          <Key className="w-5 h-5 text-muted-foreground" />
                          <div>
                            <p className="font-medium">{key.key_name}</p>
                            <p className="text-sm text-muted-foreground">{key.provider}</p>
                          </div>
                        </div>
                        
                        <div className="flex items-center gap-3">
                          <Badge variant={key.is_active ? "default" : "secondary"}>
                            {key.is_active ? "Active" : "Inactive"}
                          </Badge>
                          <AlertDialog>
                            <AlertDialogTrigger asChild>
                              <Button variant="ghost" size="sm" className="text-destructive">
                                <Trash2 className="w-4 h-4" />
                              </Button>
                            </AlertDialogTrigger>
                            <AlertDialogContent>
                              <AlertDialogHeader>
                                <AlertDialogTitle>Delete API Key?</AlertDialogTitle>
                                <AlertDialogDescription>
                                  This will permanently delete the API key "{key.key_name}". This action cannot be undone.
                                </AlertDialogDescription>
                              </AlertDialogHeader>
                              <AlertDialogFooter>
                                <AlertDialogCancel>Cancel</AlertDialogCancel>
                                <AlertDialogAction 
                                  onClick={() => handleDeleteKey(key.id)}
                                  className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                                >
                                  Delete
                                </AlertDialogAction>
                              </AlertDialogFooter>
                            </AlertDialogContent>
                          </AlertDialog>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>

            {/* AI Models Section */}
            <Card>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <div>
                    <CardTitle>Available AI Models</CardTitle>
                    <CardDescription>
                      Configure which AI models are available for XrozenAI ({models.length} models) - Higher priority = Used first
                    </CardDescription>
                  </div>
                  {models.length > 0 && (
                    <Button
                      onClick={handleBulkReorderByPriority}
                      disabled={savingPriorities}
                      variant="outline"
                      size="sm"
                    >
                      <Save className="w-4 h-4 mr-2" />
                      {savingPriorities ? "Saving..." : "Reorganize Priorities"}
                    </Button>
                  )}
                </div>
              </CardHeader>
              <CardContent>
                {models.length === 0 ? (
                  <div className="text-center py-8 text-muted-foreground">
                    <Brain className="w-12 h-12 mx-auto mb-4 opacity-50" />
                    <p>No AI models configured</p>
                    <Button onClick={handleAddFreeModels} className="mt-4" variant="outline">
                      Add Free OpenRouter Models
                    </Button>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {[...models]
                      .sort((a, b) => b.priority - a.priority)
                      .map((model, index) => (
                      <div 
                        key={model.id} 
                        className={cn(
                          "p-4 border rounded-lg transition-all",
                          model.enabled ? "bg-card" : "bg-muted/30 opacity-60"
                        )}
                      >
                        <div className="flex items-start gap-4">
                          {/* Priority Badge and Controls */}
                          <div className="flex flex-col items-center gap-2 min-w-[80px]">
                            <Badge 
                              variant={model.priority >= 80 ? "default" : model.priority >= 50 ? "secondary" : "outline"}
                              className="text-lg font-bold px-3 py-1"
                            >
                              #{index + 1}
                            </Badge>
                            
                            {editingPriority === model.id ? (
                              <div className="flex flex-col gap-1 w-full">
                                <Input
                                  type="number"
                                  value={priorityValue}
                                  onChange={(e) => setPriorityValue(parseInt(e.target.value) || 0)}
                                  className="h-8 text-center"
                                  min="1"
                                  max="100"
                                />
                                <div className="flex gap-1">
                                  <Button
                                    size="sm"
                                    variant="default"
                                    className="h-6 text-xs flex-1"
                                    onClick={() => handleUpdatePriority(model.id, priorityValue)}
                                  >
                                    Save
                                  </Button>
                                  <Button
                                    size="sm"
                                    variant="ghost"
                                    className="h-6 text-xs flex-1"
                                    onClick={() => setEditingPriority(null)}
                                  >
                                    Cancel
                                  </Button>
                                </div>
                              </div>
                            ) : (
                              <>
                                <div className="text-sm font-mono text-muted-foreground">
                                  P: {model.priority}
                                </div>
                                <div className="flex gap-1">
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    className="h-7 w-7 p-0"
                                    onClick={() => handleMovePriority(model.id, 'up')}
                                    title="Increase Priority"
                                  >
                                    <ArrowUp className="w-3 h-3" />
                                  </Button>
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    className="h-7 w-7 p-0"
                                    onClick={() => handleMovePriority(model.id, 'down')}
                                    title="Decrease Priority"
                                  >
                                    <ArrowDown className="w-3 h-3" />
                                  </Button>
                                </div>
                                <Button
                                  size="sm"
                                  variant="ghost"
                                  className="h-7 text-xs"
                                  onClick={() => {
                                    setEditingPriority(model.id);
                                    setPriorityValue(model.priority);
                                  }}
                                >
                                  Edit
                                </Button>
                              </>
                            )}
                          </div>

                          {/* Model Info */}
                          <div className="flex-1 space-y-2">
                            <div className="flex items-start justify-between gap-4">
                              <div className="space-y-1 flex-1">
                                <div className="flex items-center gap-2">
                                  <GripVertical className="w-4 h-4 text-muted-foreground" />
                                  <p className="font-medium">{model.model_name}</p>
                                </div>
                                <p className="text-sm text-muted-foreground font-mono break-all">
                                  {model.model_id}
                                </p>
                              </div>
                              
                              <Button
                                variant={model.enabled ? "default" : "outline"}
                                size="sm"
                                onClick={() => handleToggleModel(model.id, !model.enabled)}
                                className="shrink-0"
                              >
                                {model.enabled ? (
                                  <>
                                    <CheckCircle className="w-4 h-4 mr-1" />
                                    Enabled
                                  </>
                                ) : (
                                  <>
                                    <XCircle className="w-4 h-4 mr-1" />
                                    Disabled
                                  </>
                                )}
                              </Button>
                            </div>

                            <div className="flex flex-wrap gap-2">
                              <Badge variant="outline">{model.provider}</Badge>
                              {model.is_free && <Badge className="bg-green-500">Free</Badge>}
                              {model.rate_limit_per_minute && (
                                <Badge variant="secondary">
                                  Limit: {model.rate_limit_per_minute}/min
                                </Badge>
                              )}
                              <Badge variant={model.priority >= 80 ? "default" : "secondary"}>
                                Priority: {model.priority >= 80 ? "High" : model.priority >= 50 ? "Medium" : "Low"}
                              </Badge>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Info Card */}
            <Card className="bg-primary/5 border-primary/20">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <AlertCircle className="w-5 h-5" />
                  Priority System & Automatic Fallback
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-3 text-sm">
                <p>
                  <strong>ðŸŽ¯ Priority System:</strong> Models are used in order of priority (highest to lowest). Set priority 1-100 where higher numbers = higher priority.
                </p>
                <p>
                  <strong>ðŸ”„ Automatic Fallback:</strong> If a model fails (rate limit, timeout, error), the system automatically tries the next highest priority model. This ensures continuous service.
                </p>
                <p>
                  <strong>âš¡ Smart Selection:</strong> Among models with the same priority, one is randomly selected to distribute load. Disabled models are never used.
                </p>
                <p>
                  <strong>ðŸ“Š Recommended Priority Setup:</strong>
                </p>
                <ul className="list-disc list-inside space-y-1 ml-4">
                  <li>Premium Models (GPT-4o, Claude, Gemini Pro): Priority 90-100</li>
                  <li>Standard Models (GPT-3.5, Gemini Flash): Priority 70-89</li>
                  <li>Free Models (OpenRouter): Priority 40-69</li>
                  <li>Fallback Models: Priority 1-39</li>
                </ul>
                <p className="mt-3">
                  <strong>ðŸ”‘ How to Add Models:</strong>
                </p>
                <ol className="list-decimal list-inside space-y-1 ml-4">
                  <li>First, add your API key (OpenAI, Gemini, etc.)</li>
                  <li>Then click "Add OpenAI Models" or "Add Gemini Models"</li>
                  <li>Models will be automatically added with recommended priorities</li>
                  <li>Adjust priorities as needed for your use case</li>
                </ol>
                <p>
                  <strong>ðŸ’¡ Pro Tip:</strong> Keep at least 2-3 free models enabled as fallback to ensure your system never runs out of options.
                </p>
                <p>
                  <strong>ðŸ“ˆ Monitoring:</strong> All AI requests are logged with success/failure status and which model was used for debugging and optimization.
                </p>
              </CardContent>
            </Card>
          </main>
        </div>
      </div>
    </SidebarProvider>
  );
}
